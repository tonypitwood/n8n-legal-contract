var T=class{allowResourceHostOverride;authAttr;binary;bodyAttr;headers;headersAttr;host;hostAttr;method;middleware;parameterEncoder;params;path;pathAttr;queryParamAlias;signalAttr;timeoutAttr;constructor(e){this.allowResourceHostOverride=e.allowResourceHostOverride||!1,this.binary=e.binary||!1,this.headers=e.headers,this.host=e.host,this.method=e.method||"get",this.parameterEncoder=e.parameterEncoder||encodeURIComponent,this.params=e.params,this.path=e.path,this.queryParamAlias=e.queryParamAlias||{},this.authAttr=e.authAttr||"auth",this.bodyAttr=e.bodyAttr||"body",this.headersAttr=e.headersAttr||"headers",this.hostAttr=e.hostAttr||"host",this.pathAttr=e.pathAttr||"path",this.signalAttr=e.signalAttr||"signal",this.timeoutAttr=e.timeoutAttr||"timeout";let t=e.middleware||e.middlewares||[];this.middleware=t}};var A,q,L;try{A=eval('typeof __TEST_WEB__ === "undefined" && typeof process === "object" ? process : undefined')}catch(s){}var B=()=>typeof A<"u"&&A!==null&&A.hrtime;B()&&(q=()=>{let s=A.hrtime();return s[0]*1e9+s[1]},L=q());var Y=/%20/g,x=s=>s!=null,le=s=>Object.keys(s).filter(e=>x(s[e])),F=(s,e,t="",r=encodeURIComponent)=>Array.isArray(e)?e.map(o=>F(s,o,t+"[]",r)).join("&"):typeof e!="object"?`${r(s+t)}=${r(e)}`:Object.keys(e).map(o=>{let i=e[o];return x(i)?F(s,i,t+"["+o+"]",r):null}).filter(x).join("&"),M=(s,e=encodeURIComponent)=>D(s)?Object.keys(s).map(t=>{let r=s[t];return x(r)?F(t,r,"",e):null}).filter(x).join("&").replace(Y,"+"):s,H=()=>{if(B()&&q!==void 0){let s=q();if(s!==void 0&&L!==void 0)return(s-L)/1e6}return Date.now()},K=s=>{let e={};if(!s)return e;let t=s.split(`\r
`);for(let r=0;r<t.length;r++){let o=t[r],i=o.indexOf(": ");if(i>0){let n=o.substring(0,i).toLowerCase().trim(),c=o.substring(i+2).trim();e[n]=c}}return e},O=s=>Object.keys(s).reduce((e,t)=>(e[t.toLowerCase()]=s[t],e),{}),Z=Object.prototype.hasOwnProperty,m=Object.assign||function(s){for(let e=1;e<arguments.length;e++){let t=arguments[e];for(let r in t)Z.call(t,r)&&(s[r]=t[r])}return s},ee=Object.prototype.toString,D=s=>ee.call(s)==="[object Object]"&&Object.getPrototypeOf(s)===Object.getPrototypeOf({}),pe=s=>typeof s=="object"&&s!==null&&!Array.isArray(s),te="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",S=s=>{let e="",t=te,r=String(s);for(let o=0,i,n=0;r.charAt(n|0)||(t="=",n%1);e+=t.charAt(63&o>>8-n%1*8)){if(i=r.charCodeAt(n+=3/4),i>255)throw new Error("[Mappersmith] 'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");o=o<<8|i}return e};var k=class{allowResourceHostOverride;authAttr;bodyAttr;clientId;context;gatewayConfigs;headersAttr;host;hostAttr;middleware;parameterEncoder;resources;signalAttr;timeoutAttr;constructor(e,{gatewayConfigs:t,middleware:r=[],context:o={}}){this.allowResourceHostOverride=e.allowResourceHostOverride||!1,this.authAttr=e.authAttr,this.bodyAttr=e.bodyAttr,this.clientId=e.clientId||null,this.context=o,this.gatewayConfigs=m({},t,e.gatewayConfigs),this.headersAttr=e.headersAttr,this.host=e.host,this.hostAttr=e.hostAttr,this.parameterEncoder=e.parameterEncoder||encodeURIComponent,this.resources=e.resources||{},this.signalAttr=e.signalAttr,this.timeoutAttr=e.timeoutAttr;let i=e.middleware||e.middlewares||[];e.ignoreGlobalMiddleware?this.middleware=i:this.middleware=[...i,...r]}eachResource(e){Object.keys(this.resources).forEach(t=>{let r=this.eachMethod(t,o=>({name:o,descriptor:this.createMethodDescriptor(t,o)}));e(t,r)})}eachMethod(e,t){return Object.keys(this.resources[e]).map(t)}createMethodDescriptor(e,t){let r=this.resources[e][t];if(!r||!["string","function"].includes(typeof r.path))throw new Error(`[Mappersmith] path is undefined for resource "${e}" method "${t}"`);return new T(m({host:this.host,allowResourceHostOverride:this.allowResourceHostOverride,parameterEncoder:this.parameterEncoder,bodyAttr:this.bodyAttr,headersAttr:this.headersAttr,authAttr:this.authAttr,timeoutAttr:this.timeoutAttr,hostAttr:this.hostAttr,signalAttr:this.signalAttr},r))}createMiddleware(e){let t=c=>{let y={__name:c.name||c.toString(),response(u){return u()},prepareRequest(u){return this.request?u().then(g=>{var l;return(l=this.request)==null?void 0:l.call(this,g)}):u()}},f=m(e,{clientId:this.clientId,context:m({},this.context)});return m(y,c(f))},{resourceName:r,resourceMethod:o}=e;return[...this.createMethodDescriptor(r,o).middleware,...this.middleware].map(t)}};var J=/{([^}?]+)\??}/,re=/\/?{([^}?]+)\?}/g,se=/\/$/,C=class s{methodDescriptor;requestParams;requestContext;constructor(e,t={},r={}){this.methodDescriptor=e,this.requestParams=t,this.requestContext=r}isParam(e){return e!==this.methodDescriptor.headersAttr&&e!==this.methodDescriptor.bodyAttr&&e!==this.methodDescriptor.authAttr&&e!==this.methodDescriptor.timeoutAttr&&e!==this.methodDescriptor.hostAttr&&e!==this.methodDescriptor.signalAttr&&e!==this.methodDescriptor.pathAttr}params(){let e=m({},this.methodDescriptor.params,this.requestParams);return Object.keys(e).reduce((t,r)=>(this.isParam(r)&&(t[r]=e[r]),t),{})}context(){return this.requestContext}method(){return this.methodDescriptor.method.toLowerCase()}host(){let{allowResourceHostOverride:e,hostAttr:t,host:r}=this.methodDescriptor,o=e?this.requestParams[t]||r||"":r||"";return typeof o=="string"?o.replace(se,""):""}path(){let{pathAttr:e,path:t}=this.methodDescriptor,r=this.requestParams[e]||t||"",o=this.params(),i;if(typeof r=="function"){if(i=r(o),typeof i!="string")throw new Error(`[Mappersmith] method descriptor function did not return a string, params=${JSON.stringify(o)}`)}else i=r;let n=new RegExp(J,"g"),c=[],y;for(;(y=n.exec(i))!==null;)c.push(y[1]);for(let l of c){let d=new RegExp(`{${l}\\??}`,"g"),p=o[l];p!=null&&typeof p!="object"&&(i=i.replace(d,this.methodDescriptor.parameterEncoder(p)),delete o[l])}i=i.replace(re,"");let f=i.match(J);if(f)throw new Error(`[Mappersmith] required parameter missing (${f[1]}), "${i}" cannot be resolved`);let u=Object.keys(o).reduce((l,d)=>{let p=this.methodDescriptor.queryParamAlias[d]||d,a=o[d];return a!=null&&(l[p]=a),l},{}),g=M(u,this.methodDescriptor.parameterEncoder);if(typeof g=="string"&&g.length!==0){let l=i.includes("?");i+=`${l?"&":"?"}${g}`}return i[0]!=="/"&&i.length>0&&(i=`/${i}`),i}pathTemplate(){let e=this.methodDescriptor.path,t=r=>r[0]!=="/"?`/${r}`:r;return t(typeof e=="function"?e(this.params()):e)}url(){return`${this.host()}${this.path()}`}headers(){let e=this.methodDescriptor.headersAttr,t=this.requestParams[e]||{};if(typeof t=="function")return t;let r={...this.methodDescriptor.headers,...t};return O(r)}header(e){let t=e.toLowerCase();if(t in this.headers())return this.headers()[t]}body(){return this.requestParams[this.methodDescriptor.bodyAttr]}auth(){return this.requestParams[this.methodDescriptor.authAttr]}timeout(){return this.requestParams[this.methodDescriptor.timeoutAttr]}signal(){return this.requestParams[this.methodDescriptor.signalAttr]}enhance(e,t){let r=this.methodDescriptor.authAttr,o=this.methodDescriptor.bodyAttr,i=this.methodDescriptor.headersAttr,n=this.methodDescriptor.hostAttr,c=this.methodDescriptor.timeoutAttr,y=this.methodDescriptor.pathAttr,f=this.methodDescriptor.signalAttr,u=m({},this.requestParams,e.params),g=this.requestParams[i],l=m({},g,e.headers);u[i]=l,e.auth&&(u[r]=e.auth),e.body&&(u[o]=e.body),e.host&&(u[n]=e.host),e.timeout&&(u[c]=e.timeout),e.path&&(u[y]=e.path),e.signal&&(u[f]=e.signal);let d={...this.requestContext,...t};return new s(this.methodDescriptor,u,d)}isBinary(){return this.methodDescriptor.binary}};var oe=s=>!(!s||!s()),v=class{Promise;manifest;GatewayClassFactory;maxMiddlewareStackExecutionAllowed;constructor(e,t,r){if(!e)throw new Error(`[Mappersmith] invalid manifest (${e})`);if(!oe(t))throw new Error("[Mappersmith] gateway class not configured (configs.gateway)");if(!r.Promise)throw new Error("[Mappersmith] Promise not configured (configs.Promise)");this.Promise=r.Promise,this.manifest=new k(e,r),this.GatewayClassFactory=t,this.maxMiddlewareStackExecutionAllowed=r.maxMiddlewareStackExecutionAllowed}build(){let e={_manifest:this.manifest};return this.manifest.eachResource((t,r)=>{e[t]=this.buildResource(t,r)}),e}buildResource(e,t){let r={};return t.reduce((i,n)=>{let c=(y,f)=>{let u=new C(n.descriptor,y,f);return this.invokeMiddlewares(String(e),n.name,u)};return{...i,[n.name]:c}},r)}invokeMiddlewares(e,t,r){let o=this.manifest.createMiddleware({resourceName:e,resourceMethod:t}),i=this.GatewayClassFactory(),n=this.manifest.gatewayConfigs,c={middleware:null,returnedInvalidRequest:!1,abortExecution:!1},y=()=>this.Promise.resolve(r),f=(d,p)=>()=>{let a=h=>{throw c.abortExecution=!0,h};return this.Promise.resolve().then(()=>p.prepareRequest(d,a)).then(h=>{if(h instanceof C)return h;c.returnedInvalidRequest=!0;let w=typeof h,$=(w==="object"||w==="function")&&h.name||w;throw new Error(`[Mappersmith] middleware "${p.__name}" should return "Request" but returned "${$}"`)}).catch(h=>{throw c.middleware=p.__name||null,h})},u=o.reduce(f,y),g=0,l=()=>u().catch(d=>{let{returnedInvalidRequest:p,abortExecution:a,middleware:h}=c;if(p||a)throw d;let w=new Error(`[Mappersmith] middleware "${h}" failed in the request phase: ${d.message}`);throw w.stack=d.stack,w}).then(d=>{if(g++,g>this.maxMiddlewareStackExecutionAllowed)throw new Error(`[Mappersmith] infinite loop detected (middleware stack invoked ${g} times). Check the use of "renew" in one of the middleware.`);let p=l,a=($,W)=>()=>W.response($,p,d),h=()=>new i(d,n).call();return o.reduce(a,h)()});return new this.Promise((d,p)=>{l().then(a=>d(a)).catch(p)})}};var ie=/^application\/(json|.*\+json)/,R=class s{originalRequest;responseStatus;responseData;responseHeaders;errors;timeElapsed;constructor(e,t,r,o,i){let n=e.requestParams&&e.requestParams.auth;if(n){let c={...n,password:"***"};this.originalRequest=e.enhance({auth:c})}else this.originalRequest=e;this.responseStatus=t,this.responseData=r??null,this.responseHeaders=o||{},this.errors=i||[],this.timeElapsed=null}request(){return this.originalRequest}status(){return this.responseStatus===1223?204:this.responseStatus}success(){let e=this.status();return e>=200&&e<400}headers(){return O(this.responseHeaders)}header(e){let t=e.toLowerCase();if(t in this.headers())return this.headers()[t]}rawData(){return this.responseData}data(){if(this.isContentTypeJSON()&&this.responseData!==null)try{return JSON.parse(this.responseData)}catch{}return this.responseData}isContentTypeJSON(){let e=this.header("content-type");return e===void 0?!1:ie.test(e)}error(){let e=this.errors[this.errors.length-1]||null;return typeof e=="string"?new Error(e):e}enhance(e){let t={...this.headers(),...e.headers||{}},r=new s(this.request(),e.status||this.status(),e.rawData||this.rawData(),t,e.error?[...this.errors,e.error]:[...this.errors]);return r.timeElapsed=this.timeElapsed,r}},G=R;var U="2.46.0";var b={context:{},middleware:[],Promise:typeof Promise=="function"?Promise:null,fetch:typeof fetch=="function"?fetch:null,maxMiddlewareStackExecutionAllowed:2,gateway:null,gatewayConfigs:{emulateHTTP:!1,enableHTTP408OnTimeouts:!1,XHR:{withCredentials:!1,configure:null},HTTP:{useSocketConnectionTimeout:!1,configure:null,onRequestWillStart:null,onRequestSocketAssigned:null,onSocketLookup:null,onSocketConnect:null,onSocketSecureConnect:null,onResponseReadable:null,onResponseEnd:null},Fetch:{credentials:"omit"}}},ne=s=>{console.warn("The use of setContext is deprecated - you need to find another way to pass data between your middlewares."),b.context=m(b.context,s)};function I(s){let e=()=>b.gateway;return new v(s,e,b).build()}var z=s=>s&&s.name==="TimeoutError",E=s=>{let e=new Error(s);return e.name="TimeoutError",e};var ae=/^(delete|put|patch)/i,P=class{request;configs;successCallback;failCallback;constructor(e,t){this.request=e,this.configs=t,this.successCallback=function(){},this.failCallback=function(){}}get(){throw new Error("Not implemented")}head(){throw new Error("Not implemented")}post(){throw new Error("Not implemented")}put(){throw new Error("Not implemented")}patch(){throw new Error("Not implemented")}delete(){throw new Error("Not implemented")}options(){return this.configs}shouldEmulateHTTP(){return this.options().emulateHTTP&&ae.test(this.request.method())}call(){let e=H();if(!b.Promise)throw new Error("[Mappersmith] Promise not configured (configs.Promise)");return new b.Promise((t,r)=>{this.successCallback=o=>{o.timeElapsed=H()-e,t(o)},this.failCallback=o=>{o.timeElapsed=H()-e,r(o)};try{this[this.request.method()].apply(this,arguments)}catch(o){let i=o;this.dispatchClientError(i.message,i)}})}dispatchResponse(e){e.success()?this.successCallback(e):this.failCallback(e)}dispatchClientError(e,t){z(t)&&this.options().enableHTTP408OnTimeouts?this.failCallback(new R(this.request,408,e,{},[t])):this.failCallback(new R(this.request,400,e,{},[t]))}prepareBody(e,t){let r=this.request.body();this.shouldEmulateHTTP()&&(r=r||{},D(r)&&(r._method=e),t["x-http-method-override"]=e);let o=M(r);return o&&D(r)&&(t["content-type"]="application/x-www-form-urlencoded;charset=utf-8"),o}};var X;try{X=window.btoa}catch{X=S}var N=class extends P{canceled=!1;timer;get(){let e=this.createXHR();e.open("GET",this.request.url(),!0),this.setHeaders(e,{}),this.configureTimeout(e),this.configureBinary(e),this.configureAbort(e),e.send()}head(){let e=this.createXHR();e.open("HEAD",this.request.url(),!0),this.setHeaders(e,{}),this.configureTimeout(e),this.configureBinary(e),this.configureAbort(e),e.send()}post(){this.performRequest("post")}put(){this.performRequest("put")}patch(){this.performRequest("patch")}delete(){this.performRequest("delete")}configureBinary(e){this.request.isBinary()&&(e.responseType="blob")}configureTimeout(e){this.canceled=!1,this.timer=void 0;let t=this.request.timeout();t&&(e.timeout=t,e.addEventListener("timeout",()=>{this.canceled=!0,this.timer&&clearTimeout(this.timer);let r=E(`Timeout (${t}ms)`);this.dispatchClientError(r.message,r)}),this.timer=setTimeout(()=>{this.canceled=!0;let r=E(`Timeout (${t}ms)`);this.dispatchClientError(r.message,r)},t+1))}configureAbort(e){let t=this.request.signal();t&&(t.addEventListener("abort",()=>{e.abort()}),e.addEventListener("abort",()=>{this.dispatchClientError("The operation was aborted",new Error("The operation was aborted"))}))}configureCallbacks(e){e.addEventListener("load",()=>{this.canceled||(this.timer&&clearTimeout(this.timer),this.dispatchResponse(this.createResponse(e)))}),e.addEventListener("error",r=>{if(this.canceled)return;this.timer&&clearTimeout(this.timer);let o=r?r.message||r.name:e.responseText,i="Network error",n=o?`: ${o}`:"",c=new Error(`${i}${n}`);this.dispatchClientError(i,c)});let t=this.options().XHR;t.withCredentials&&(e.withCredentials=!0),t.configure&&t.configure(e)}performRequest(e){let t=this.shouldEmulateHTTP()?"post":e,r=this.createXHR();r.open(t.toUpperCase(),this.request.url(),!0);let o={},i=this.prepareBody(e,o);this.setHeaders(r,o),this.configureTimeout(r),this.configureBinary(r),this.configureAbort(r),r.send(i)}createResponse(e){let t=e.status,r=this.request.isBinary()?e.response:e.responseText,o=K(e.getAllResponseHeaders());return new G(this.request,t,r,o)}setHeaders(e,t){let r=this.request.auth(),o=m(t,{...this.request.headers(),...r?{authorization:`Basic ${X(`${r.username}:${r.password}`)}`}:{}});Object.keys(o).forEach(i=>{e.setRequestHeader(i,`${o[i]}`)})}createXHR(){let e=new XMLHttpRequest;return this.configureCallbacks(e),e}};function ce(s,e){let t=new AbortController;return s.addEventListener("abort",()=>t.abort(),{once:!0}),e==null||e.addEventListener("abort",()=>t.abort(),{once:!0}),t.signal}var j=class extends P{get(){this.performRequest("get")}head(){this.performRequest("head")}post(){this.performRequest("post")}put(){this.performRequest("put")}patch(){this.performRequest("patch")}delete(){this.performRequest("delete")}performRequest(e){let t=b.fetch;if(!t)throw new Error('[Mappersmith] global fetch does not exist, please assign "configs.fetch" to a valid implementation');let r={},o=this.prepareBody(e,r),i=this.request.auth();if(i){let a=i.username||"",h=i.password||"";r.authorization=`Basic ${S(`${a}:${h}`)}`}let n=m(r,this.request.headers()),c=this.shouldEmulateHTTP()?"post":e,y=this.request.signal(),f=new AbortController,u;y?u=ce(f.signal,y):u=f.signal;let g=m({method:c,headers:n,body:o,signal:u},this.options().Fetch),l=this.request.timeout(),d=null,p=!1;l&&(d=setTimeout(()=>{f.abort(),p=!0;let a=E(`Timeout (${l}ms)`);this.dispatchClientError(a.message,a)},l)),t(this.request.url(),g).then(a=>{if(p)return;let h;this.request.isBinary()?typeof a.buffer=="function"?h=a.buffer():h=a.arrayBuffer():h=a.text(),h.then(w=>{this.dispatchResponse(this.createResponse(a,w))})}).catch(a=>{p||this.dispatchClientError(a.message,a)}).finally(()=>{d&&clearTimeout(d)})}createResponse(e,t){let r=e.status,o={};return e.headers.forEach((i,n)=>{o[n]=i}),new G(this.request,r,t,o)}};var Q=null,_=null;try{Q=eval('typeof __TEST_SERVICE_WORKER__ === "undefined" && typeof process === "object" ? process : undefined')}catch(s){}typeof XMLHttpRequest<"u"?_=N:typeof Q<"u"?_=void 0:typeof self<"u"&&(_=j);b.gateway=_;export{R as Response,b as configs,I as default,I as forge,ne as setContext,U as version};
//# sourceMappingURL=mappersmith.production.min.mjs.map