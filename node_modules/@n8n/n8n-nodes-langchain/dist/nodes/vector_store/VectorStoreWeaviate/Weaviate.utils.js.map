{"version":3,"sources":["../../../../nodes/vector_store/VectorStoreWeaviate/Weaviate.utils.ts"],"sourcesContent":["import { OperationalError } from 'n8n-workflow';\nimport type {\n\tFilterValue,\n\tGeoRangeFilter,\n\tProxiesParams,\n\tTimeoutParams,\n\tWeaviateClient,\n} from 'weaviate-client';\nimport weaviate, { Filters } from 'weaviate-client';\n\nexport type WeaviateCredential = {\n\tweaviate_cloud_endpoint: string;\n\tweaviate_api_key: string;\n\tcustom_connection_http_host: string;\n\tcustom_connection_http_port: number;\n\tcustom_connection_http_secure: boolean;\n\tcustom_connection_grpc_host: string;\n\tcustom_connection_grpc_port: number;\n\tcustom_connection_grpc_secure: boolean;\n};\n\nexport async function createWeaviateClient(\n\tcredentials: WeaviateCredential,\n\ttimeout?: TimeoutParams,\n\tproxies?: ProxiesParams,\n\tskipInitChecks: boolean = false,\n): Promise<WeaviateClient> {\n\tif (credentials.weaviate_cloud_endpoint) {\n\t\tconst weaviateClient: WeaviateClient = await weaviate.connectToWeaviateCloud(\n\t\t\tcredentials.weaviate_cloud_endpoint,\n\t\t\t{\n\t\t\t\tauthCredentials: new weaviate.ApiKey(credentials.weaviate_api_key),\n\t\t\t\ttimeout,\n\t\t\t\tskipInitChecks,\n\t\t\t},\n\t\t);\n\t\treturn weaviateClient;\n\t} else {\n\t\tconst weaviateClient: WeaviateClient = await weaviate.connectToCustom({\n\t\t\thttpHost: credentials.custom_connection_http_host,\n\t\t\thttpPort: credentials.custom_connection_http_port,\n\t\t\tgrpcHost: credentials.custom_connection_grpc_host,\n\t\t\tgrpcPort: credentials.custom_connection_grpc_port,\n\t\t\tgrpcSecure: credentials.custom_connection_grpc_secure,\n\t\t\thttpSecure: credentials.custom_connection_http_secure,\n\t\t\tauthCredentials: credentials.weaviate_api_key\n\t\t\t\t? new weaviate.ApiKey(credentials.weaviate_api_key)\n\t\t\t\t: undefined,\n\t\t\ttimeout,\n\t\t\tproxies,\n\t\t\tskipInitChecks,\n\t\t});\n\t\treturn weaviateClient;\n\t}\n}\ntype WeaviateFilterUnit = {\n\tpath: string[];\n\toperator: string;\n\tvalueString?: string;\n\tvalueTextArray?: string[];\n\tvalueBoolean?: boolean;\n\tvalueNumber?: number;\n\tvalueGeoCoordinates?: GeoRangeFilter;\n};\n\nexport type WeaviateCompositeFilter = { AND: WeaviateFilterUnit[] } | { OR: WeaviateFilterUnit[] };\n\nfunction buildFilter(filter: WeaviateFilterUnit): FilterValue {\n\tconst { path, operator } = filter;\n\tconst property = weaviate.filter.byProperty(path[0]);\n\n\tswitch (operator.toLowerCase()) {\n\t\tcase 'equal':\n\t\t\tif (filter.valueString !== undefined) return property.equal(filter.valueString);\n\t\t\tif (filter.valueNumber !== undefined) return property.equal(filter.valueNumber);\n\t\t\tbreak;\n\n\t\tcase 'like':\n\t\t\tif (filter.valueString === undefined) {\n\t\t\t\tthrow new OperationalError(\"Missing 'valueString' for 'like' operator.\");\n\t\t\t}\n\t\t\treturn property.like(filter.valueString);\n\n\t\tcase 'containsany':\n\t\t\tif (filter.valueTextArray === undefined) {\n\t\t\t\tthrow new OperationalError(\"Missing 'valueTextArray' for 'containsAny' operator.\");\n\t\t\t}\n\t\t\treturn property.containsAny(filter.valueTextArray);\n\n\t\tcase 'containsall':\n\t\t\tif (filter.valueTextArray === undefined) {\n\t\t\t\tthrow new OperationalError(\"Missing 'valueTextArray' for 'containsAll' operator.\");\n\t\t\t}\n\t\t\treturn property.containsAll(filter.valueTextArray);\n\n\t\tcase 'greaterthan':\n\t\t\tif (filter.valueNumber === undefined) {\n\t\t\t\tthrow new OperationalError(\"Missing 'valueNumber' for 'greaterThan' operator.\");\n\t\t\t}\n\t\t\treturn property.greaterThan(filter.valueNumber);\n\n\t\tcase 'lessthan':\n\t\t\tif (filter.valueNumber === undefined) {\n\t\t\t\tthrow new OperationalError(\"Missing 'valueNumber' for 'lessThan' operator.\");\n\t\t\t}\n\t\t\treturn property.lessThan(filter.valueNumber);\n\n\t\tcase 'isnull':\n\t\t\tif (filter.valueBoolean === undefined) {\n\t\t\t\tthrow new OperationalError(\"Missing 'valueBoolean' for 'isNull' operator.\");\n\t\t\t}\n\t\t\treturn property.isNull(filter.valueBoolean);\n\n\t\tcase 'withingeorange':\n\t\t\tif (!filter.valueGeoCoordinates) {\n\t\t\t\tthrow new OperationalError(\"Missing 'valueGeoCoordinates' for 'withinGeoRange' operator.\");\n\t\t\t}\n\t\t\treturn property.withinGeoRange(filter.valueGeoCoordinates);\n\n\t\tdefault:\n\t\t\tthrow new OperationalError(`Unsupported operator: ${operator}`);\n\t}\n\n\tthrow new OperationalError(`No valid filter value provided for operator: ${operator}`);\n}\n\nexport function parseCompositeFilter(\n\tfilter: WeaviateCompositeFilter | WeaviateFilterUnit,\n): FilterValue {\n\t// Handle composite filters (AND/OR)\n\tif (typeof filter === 'object' && ('AND' in filter || 'OR' in filter)) {\n\t\tif ('AND' in filter) {\n\t\t\treturn Filters.and(...filter.AND.map(buildFilter));\n\t\t} else if ('OR' in filter) {\n\t\t\treturn Filters.or(...filter.OR.map(buildFilter));\n\t\t}\n\t}\n\n\t// Handle individual filter units\n\treturn buildFilter(filter);\n}\n"],"mappings":"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","names":["weaviate"]}