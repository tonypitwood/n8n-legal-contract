{"version":3,"sources":["../../utils/N8nJsonLoader.ts"],"sourcesContent":["import type { Document } from '@langchain/core/documents';\nimport type { TextSplitter } from '@langchain/textsplitters';\nimport { JSONLoader } from 'langchain/document_loaders/fs/json';\nimport { TextLoader } from 'langchain/document_loaders/fs/text';\nimport {\n\ttype IExecuteFunctions,\n\ttype INodeExecutionData,\n\ttype ISupplyDataFunctions,\n\tNodeOperationError,\n} from 'n8n-workflow';\n\nimport { getMetadataFiltersValues } from './helpers';\n\nexport class N8nJsonLoader {\n\tconstructor(\n\t\tprivate context: IExecuteFunctions | ISupplyDataFunctions,\n\t\tprivate optionsPrefix = '',\n\t\tprivate textSplitter?: TextSplitter,\n\t) {}\n\n\tasync processAll(items?: INodeExecutionData[]): Promise<Document[]> {\n\t\tconst docs: Document[] = [];\n\n\t\tif (!items) return [];\n\n\t\tfor (let itemIndex = 0; itemIndex < items.length; itemIndex++) {\n\t\t\tconst processedDocuments = await this.processItem(items[itemIndex], itemIndex);\n\n\t\t\tdocs.push(...processedDocuments);\n\t\t}\n\n\t\treturn docs;\n\t}\n\n\tasync processItem(item: INodeExecutionData, itemIndex: number): Promise<Document[]> {\n\t\tconst mode = this.context.getNodeParameter('jsonMode', itemIndex, 'allInputData') as\n\t\t\t| 'allInputData'\n\t\t\t| 'expressionData';\n\n\t\tconst pointers = this.context.getNodeParameter(\n\t\t\t`${this.optionsPrefix}pointers`,\n\t\t\titemIndex,\n\t\t\t'',\n\t\t) as string;\n\t\tconst pointersArray = pointers.split(',').map((pointer) => pointer.trim());\n\t\tconst metadata = getMetadataFiltersValues(this.context, itemIndex) ?? [];\n\n\t\tif (!item) return [];\n\n\t\tlet documentLoader: JSONLoader | TextLoader | null = null;\n\n\t\tif (mode === 'allInputData') {\n\t\t\tconst itemString = JSON.stringify(item.json);\n\t\t\tconst itemBlob = new Blob([itemString], { type: 'application/json' });\n\t\t\tdocumentLoader = new JSONLoader(itemBlob, pointersArray);\n\t\t}\n\n\t\tif (mode === 'expressionData') {\n\t\t\tconst dataString = this.context.getNodeParameter('jsonData', itemIndex) as string | object;\n\t\t\tif (typeof dataString === 'object') {\n\t\t\t\tconst itemBlob = new Blob([JSON.stringify(dataString)], { type: 'application/json' });\n\t\t\t\tdocumentLoader = new JSONLoader(itemBlob, pointersArray);\n\t\t\t}\n\n\t\t\tif (typeof dataString === 'string') {\n\t\t\t\tconst itemBlob = new Blob([dataString], { type: 'text/plain' });\n\t\t\t\tdocumentLoader = new TextLoader(itemBlob);\n\t\t\t}\n\t\t}\n\n\t\tif (documentLoader === null) {\n\t\t\t// This should never happen\n\t\t\tthrow new NodeOperationError(this.context.getNode(), 'Document loader is not initialized');\n\t\t}\n\n\t\tconst docs = this.textSplitter\n\t\t\t? await this.textSplitter.splitDocuments(await documentLoader.load())\n\t\t\t: await documentLoader.load();\n\n\t\tif (metadata) {\n\t\t\tdocs.forEach((doc) => {\n\t\t\t\tdoc.metadata = {\n\t\t\t\t\t...doc.metadata,\n\t\t\t\t\t...metadata,\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\t\treturn docs;\n\t}\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA,kBAA2B;AAC3B,kBAA2B;AAC3B,0BAKO;AAEP,qBAAyC;AAElC,MAAM,cAAc;AAAA,EAC1B,YACS,SACA,gBAAgB,IAChB,cACP;AAHO;AACA;AACA;AAAA,EACN;AAAA,EAEH,MAAM,WAAW,OAAmD;AACnE,UAAM,OAAmB,CAAC;AAE1B,QAAI,CAAC,MAAO,QAAO,CAAC;AAEpB,aAAS,YAAY,GAAG,YAAY,MAAM,QAAQ,aAAa;AAC9D,YAAM,qBAAqB,MAAM,KAAK,YAAY,MAAM,SAAS,GAAG,SAAS;AAE7E,WAAK,KAAK,GAAG,kBAAkB;AAAA,IAChC;AAEA,WAAO;AAAA,EACR;AAAA,EAEA,MAAM,YAAY,MAA0B,WAAwC;AACnF,UAAM,OAAO,KAAK,QAAQ,iBAAiB,YAAY,WAAW,cAAc;AAIhF,UAAM,WAAW,KAAK,QAAQ;AAAA,MAC7B,GAAG,KAAK,aAAa;AAAA,MACrB;AAAA,MACA;AAAA,IACD;AACA,UAAM,gBAAgB,SAAS,MAAM,GAAG,EAAE,IAAI,CAAC,YAAY,QAAQ,KAAK,CAAC;AACzE,UAAM,eAAW,yCAAyB,KAAK,SAAS,SAAS,KAAK,CAAC;AAEvE,QAAI,CAAC,KAAM,QAAO,CAAC;AAEnB,QAAI,iBAAiD;AAErD,QAAI,SAAS,gBAAgB;AAC5B,YAAM,aAAa,KAAK,UAAU,KAAK,IAAI;AAC3C,YAAM,WAAW,IAAI,KAAK,CAAC,UAAU,GAAG,EAAE,MAAM,mBAAmB,CAAC;AACpE,uBAAiB,IAAI,uBAAW,UAAU,aAAa;AAAA,IACxD;AAEA,QAAI,SAAS,kBAAkB;AAC9B,YAAM,aAAa,KAAK,QAAQ,iBAAiB,YAAY,SAAS;AACtE,UAAI,OAAO,eAAe,UAAU;AACnC,cAAM,WAAW,IAAI,KAAK,CAAC,KAAK,UAAU,UAAU,CAAC,GAAG,EAAE,MAAM,mBAAmB,CAAC;AACpF,yBAAiB,IAAI,uBAAW,UAAU,aAAa;AAAA,MACxD;AAEA,UAAI,OAAO,eAAe,UAAU;AACnC,cAAM,WAAW,IAAI,KAAK,CAAC,UAAU,GAAG,EAAE,MAAM,aAAa,CAAC;AAC9D,yBAAiB,IAAI,uBAAW,QAAQ;AAAA,MACzC;AAAA,IACD;AAEA,QAAI,mBAAmB,MAAM;AAE5B,YAAM,IAAI,uCAAmB,KAAK,QAAQ,QAAQ,GAAG,oCAAoC;AAAA,IAC1F;AAEA,UAAM,OAAO,KAAK,eACf,MAAM,KAAK,aAAa,eAAe,MAAM,eAAe,KAAK,CAAC,IAClE,MAAM,eAAe,KAAK;AAE7B,QAAI,UAAU;AACb,WAAK,QAAQ,CAAC,QAAQ;AACrB,YAAI,WAAW;AAAA,UACd,GAAG,IAAI;AAAA,UACP,GAAG;AAAA,QACJ;AAAA,MACD,CAAC;AAAA,IACF;AACA,WAAO;AAAA,EACR;AACD;","names":[]}