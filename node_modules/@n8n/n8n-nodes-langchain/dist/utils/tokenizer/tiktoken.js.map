{"version":3,"sources":["../../../utils/tokenizer/tiktoken.ts"],"sourcesContent":["import { readFile } from 'fs/promises';\nimport type { TiktokenBPE, TiktokenEncoding, TiktokenModel } from 'js-tiktoken/lite';\nimport { Tiktoken, getEncodingNameForModel } from 'js-tiktoken/lite';\nimport { jsonParse } from 'n8n-workflow';\nimport { join } from 'path';\n\nconst cache: Record<string, Promise<Tiktoken>> = {};\n\nconst loadJSONFile = async (filename: string): Promise<TiktokenBPE> => {\n\tconst filePath = join(__dirname, filename);\n\tconst content = await readFile(filePath, 'utf-8');\n\treturn await jsonParse(content);\n};\n\nexport async function getEncoding(encoding: TiktokenEncoding): Promise<Tiktoken> {\n\tif (!(encoding in cache)) {\n\t\t// Create and cache the promise for loading this encoding\n\t\tcache[encoding] = (async () => {\n\t\t\tlet jsonData: TiktokenBPE;\n\n\t\t\tswitch (encoding) {\n\t\t\t\tcase 'o200k_base':\n\t\t\t\t\tjsonData = await loadJSONFile('./o200k_base.json');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'cl100k_base':\n\t\t\t\t\tjsonData = await loadJSONFile('./cl100k_base.json');\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\t// Fall back to cl100k_base for unsupported encodings\n\t\t\t\t\tjsonData = await loadJSONFile('./cl100k_base.json');\n\t\t\t}\n\n\t\t\treturn new Tiktoken(jsonData);\n\t\t})().catch((error) => {\n\t\t\tdelete cache[encoding];\n\t\t\tthrow error;\n\t\t});\n\t}\n\n\treturn await cache[encoding];\n}\n\nexport async function encodingForModel(model: TiktokenModel): Promise<Tiktoken> {\n\treturn await getEncoding(getEncodingNameForModel(model));\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sBAAyB;AAEzB,kBAAkD;AAClD,0BAA0B;AAC1B,kBAAqB;AAErB,MAAM,QAA2C,CAAC;AAElD,MAAM,eAAe,OAAO,aAA2C;AACtE,QAAM,eAAW,kBAAK,WAAW,QAAQ;AACzC,QAAM,UAAU,UAAM,0BAAS,UAAU,OAAO;AAChD,SAAO,UAAM,+BAAU,OAAO;AAC/B;AAEA,eAAsB,YAAY,UAA+C;AAChF,MAAI,EAAE,YAAY,QAAQ;AAEzB,UAAM,QAAQ,KAAK,YAAY;AAC9B,UAAI;AAEJ,cAAQ,UAAU;AAAA,QACjB,KAAK;AACJ,qBAAW,MAAM,aAAa,mBAAmB;AACjD;AAAA,QACD,KAAK;AACJ,qBAAW,MAAM,aAAa,oBAAoB;AAClD;AAAA,QACD;AAEC,qBAAW,MAAM,aAAa,oBAAoB;AAAA,MACpD;AAEA,aAAO,IAAI,qBAAS,QAAQ;AAAA,IAC7B,GAAG,EAAE,MAAM,CAAC,UAAU;AACrB,aAAO,MAAM,QAAQ;AACrB,YAAM;AAAA,IACP,CAAC;AAAA,EACF;AAEA,SAAO,MAAM,MAAM,QAAQ;AAC5B;AAEA,eAAsB,iBAAiB,OAAyC;AAC/E,SAAO,MAAM,gBAAY,qCAAwB,KAAK,CAAC;AACxD;","names":[]}